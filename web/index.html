<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Enterprise AI Gateway</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1.5.10/css/pico.min.css" />
  <style>
    :root {
      --surface: rgba(255, 255, 255, 0.75);
      --glass-border: 1px solid rgba(255, 255, 255, 0.25);
      --shadow: 0 20px 60px rgba(15, 23, 42, 0.18);
    }

    body {
      padding: 0;
      background: radial-gradient(circle at 20% 20%, #ecfeff 0, #f8fafc 40%, #e2e8f0 100%);
      color: #0f172a;
      min-height: 100vh;
      font-family: "Inter", system-ui, -apple-system, sans-serif;
    }

    header {
      background: linear-gradient(120deg, #0ea5e9, #6366f1, #8b5cf6);
      color: #f8fafc;
      padding: 2rem 1.5rem 1.5rem;
      box-shadow: var(--shadow);
    }

    header .container {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 1rem;
      align-items: center;
    }

    .tagline {
      opacity: 0.9;
      margin-bottom: 0.5rem;
    }

    .actions {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .glass {
      background: var(--surface);
      border: var(--glass-border);
      backdrop-filter: blur(6px);
      box-shadow: var(--shadow);
    }

    main.container {
      margin-top: -2.5rem;
      padding: 1.5rem;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      background: #e0f2fe;
      color: #0ea5e9;
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
      font-weight: 600;
      font-size: 0.9rem;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 1rem;
    }

    .debug {
      background: #0f172a;
      color: #e2e8f0;
      padding: 1rem;
      border-radius: 8px;
      font-family: "JetBrains Mono", SFMono-Regular, ui-monospace, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      overflow: auto;
    }

    textarea {
      min-height: 140px;
    }

    .status-ok { color: #16a34a; }
    .status-error { color: #dc2626; }
    .status-warning { color: #d97706; }

    .hint {
      display: flex;
      gap: 0.6rem;
      align-items: flex-start;
      background: #f8fafc;
      border-left: 4px solid #0ea5e9;
      padding: 0.75rem 0.9rem;
      border-radius: 8px;
      margin: 0.5rem 0 1rem;
    }

    details summary {
      cursor: pointer;
    }

    .info-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 1.5rem;
      height: 1.5rem;
      border-radius: 50%;
      background: #e0f2fe;
      color: #0ea5e9;
      font-weight: 700;
      border: 1px solid #bae6fd;
    }

    .muted {
      color: #475569;
      font-size: 0.95rem;
    }

    .inline-code {
      background: #e2e8f0;
      border-radius: 6px;
      padding: 0 0.3rem;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <div>
        <p class="tagline">Enterprise-grade speech + LLM routing</p>
        <h1>Enterprise AI Gateway</h1>
        <p class="muted">Pick providers, run quick smoke tests, and share this page with teammates. Secrets stay server-side.</p>
      </div>
      <div class="actions">
        <a class="contrast outline" href="../README.md" target="_blank">Project README</a>
        <a class="contrast outline" href="../docs/README.md" target="_blank">Docs index</a>
        <span class="pill" title="Correlate requests across services">ðŸ”— Correlation-ready</span>
      </div>
    </div>
  </header>

  <main class="container">
    <article class="glass" style="padding: 1.25rem;">
      <div class="grid" style="align-items: flex-end;">
        <div>
          <p class="muted">Backend endpoint</p>
          <label>API base URL
            <input id="api-base" type="text" placeholder="http://localhost:8000" />
          </label>
          <small class="muted">Stored in localStorage so you can point this page at your laptop, dev tunnel, or deployed gateway.</small>
        </div>
        <div>
          <label>&nbsp;
            <button id="save-api-base">Save endpoint</button>
          </label>
          <p class="hint"><span class="info-icon">i</span><span>Use your local machine URL (e.g., <span class="inline-code">http://127.0.0.1:8000</span>) if testing the backend from this device. Keys stay in the backend.</span></p>
        </div>
      </div>
    </article>

    <details open class="glass" style="padding: 1rem; margin-top: 1rem;">
      <summary><strong>Setup (backend owns keys)</strong></summary>
      <p>Validate backend configuration. Keys live in <code>.env</code> or your secret store; the browser never sees them.</p>
      <div id="setup-status" class="muted">Waiting to validate...</div>
      <button id="validate-btn">Validate Configuration</button>
      <p class="muted">
        See <a href="../docs/05-security.md" target="_blank">security</a> and <a href="../docs/03-connectors.md" target="_blank">connectors</a> docs.
      </p>
    </details>

    <section class="glass" style="padding: 1.25rem; margin-top: 1rem;">
      <div class="grid">
        <label>Channel
          <select id="channel">
            <option value="web">Web</option>
            <option value="teams">Teams</option>
            <option value="ivr">IVR</option>
            <option value="android">Android</option>
          </select>
        </label>
        <label>LLM provider
          <select id="llm-provider"></select>
        </label>
        <label>LLM model
          <input id="llm-model" type="text" placeholder="assistant-lite" />
        </label>
        <label>RAG provider
          <select id="rag-provider"></select>
        </label>
        <label>RAG index
          <input id="rag-index" type="text" placeholder="default" />
        </label>
        <label>STT provider
          <select id="stt-provider"></select>
        </label>
        <label>STT model
          <input id="stt-model" type="text" placeholder="narrowband" />
        </label>
        <label>TTS provider
          <select id="tts-provider"></select>
        </label>
        <label>TTS voice
          <input id="tts-voice" type="text" placeholder="alloy" />
        </label>
        <label>Service desk
          <select id="servicedesk-provider"></select>
        </label>
      </div>

      <div class="grid" style="margin-top: 1rem;">
        <label><input type="checkbox" id="use-rag" checked /> Use RAG</label>
        <label><input type="checkbox" id="include-debug" checked /> Include debug</label>
      </div>

      <label style="margin-top: 1rem;">Message
        <textarea id="message" placeholder="Describe your issue..."></textarea>
      </label>
      <button id="send">Send</button>
    </section>

    <section class="grid" style="margin-top: 1rem;">
      <article class="glass" style="padding: 1rem;">
        <div style="display:flex; align-items:center; justify-content: space-between;">
          <h3 style="margin-bottom: 0.25rem;">Response</h3>
          <span class="pill" title="Server-side validation & routing">ðŸ§­ Gateway</span>
        </div>
        <p id="response" class="muted">Waiting for a message...</p>
      </article>

      <article class="glass" style="padding: 1rem;">
        <div style="display:flex; align-items:center; justify-content: space-between;">
          <h3 style="margin-bottom: 0.25rem;">Debug drawer</h3>
          <span class="info-icon" title="Shows routing, RAG usage, and latency">i</span>
        </div>
        <article class="debug">
          <pre id="debug">Waiting for response...</pre>
        </article>
      </article>
    </section>
  </main>

  <script>
    let apiBase = localStorage.getItem('apiBase') || 'http://localhost:8000';
    const responseEl = document.getElementById('response');
    const debugEl = document.getElementById('debug');
    const setupEl = document.getElementById('setup-status');
    const apiBaseInput = document.getElementById('api-base');
    const selects = ['llm-provider','rag-provider','stt-provider','tts-provider','servicedesk-provider'];
    const presetEl = document.getElementById('preset');

    const fallbackRegistry = {
      llm: [
        { id: 'ollama-local', display_name: 'Local Ollama', configured: true, requires_auth: false },
        { id: 'elevenlabs-llm', display_name: 'ElevenLabs LLM (stub)', configured: false, requires_auth: true },
      ],
      rag: [
        { id: 'local-embeddings', display_name: 'Local embeddings (stub)', configured: false, requires_auth: false },
      ],
      stt: [
        { id: 'whisper-local', display_name: 'Local Whisper', configured: true, requires_auth: false },
        { id: 'elevenlabs-stt', display_name: 'ElevenLabs STT (stub)', configured: false, requires_auth: true },
      ],
      tts: [
        { id: 'speakback-local', display_name: 'Local speak-back', configured: true, requires_auth: false },
        { id: 'elevenlabs-tts', display_name: 'ElevenLabs TTS (stub)', configured: false, requires_auth: true },
      ],
      servicedesk: [
        { id: 'freshdesk-stub', display_name: 'Service desk (stub)', configured: false, requires_auth: true },
      ],
    };

    const presets = {
      'demo-local': {
        llm_provider: 'ollama-local',
        llm_model: 'assistant-lite',
        rag_provider: 'local-embeddings',
        rag_index: 'default',
        stt_provider: 'whisper-local',
        stt_model: 'narrowband',
        tts_provider: 'speakback-local',
        tts_voice: 'alloy',
      },
      'elevenlabs': {
        llm_provider: 'elevenlabs-llm',
        llm_model: 'smart-context',
        rag_provider: 'local-embeddings',
        rag_index: 'default',
        stt_provider: 'elevenlabs-stt',
        stt_model: 'default',
        tts_provider: 'elevenlabs-tts',
        tts_voice: 'eleven-voice',
      },
    };

    apiBaseInput.value = apiBase;

    function setStatus(text, cssClass = '') {
      setupEl.classList.remove('status-ok', 'status-warning', 'status-error');
      if (cssClass) setupEl.classList.add(cssClass);
      setupEl.innerHTML = text;
    }

    apiBaseInput.value = apiBase;

    function setStatus(text, cssClass = '') {
      setupEl.classList.remove('status-ok', 'status-warning', 'status-error');
      if (cssClass) setupEl.classList.add(cssClass);
      setupEl.innerHTML = text;
    }

    async function loadRegistry() {
      try {
        const res = await fetch(`${apiBase}/v1/registry`);
        if (!res.ok) throw new Error(`Registry failed: ${res.status}`);
        const data = await res.json();
        const map = {
          'llm-provider': data.llm,
          'rag-provider': data.rag,
          'stt-provider': data.stt,
          'tts-provider': data.tts,
          'servicedesk-provider': [{id:'', display_name:'None', capabilities:[], supported:[], requires_auth:false, status:'enabled', configured:true}, ...data.servicedesk],
        };
        selects.forEach(id => {
          const select = document.getElementById(id);
          select.innerHTML = '';
          map[id].forEach(item => {
            const opt = document.createElement('option');
            opt.value = item.id;
            opt.textContent = `${item.display_name} ${item.requires_auth ? '(auth)' : ''}${item.configured ? '' : ' (not configured)'}`;
            select.appendChild(opt);
          });
        });
      } catch (err) {
        responseEl.textContent = 'Unable to load registry. Check your API base URL and backend logs.';
        debugEl.textContent = err.message;
      }
    }

    async function validateConfig() {
      setStatus('Validating...');
      try {
        const res = await fetch(`${apiBase}/v1/admin/config/validate`);
        if (!res.ok) throw new Error(`Validation failed: ${res.status}`);
        const data = await res.json();
        const statusList = data.results.map(item => {
          const css = item.status === 'ok' ? 'status-ok' : (item.status === 'not_configured' ? 'status-warning' : 'status-error');
          return `<li class="${css}">${item.service_type} :: ${item.provider} - ${item.status} (${item.reason})</li>`;
        }).join('');
        setStatus(`<strong>Overall: ${data.status}</strong><ul>${statusList}</ul>`, data.status === 'ok' ? 'status-ok' : 'status-warning');
      } catch (err) {
        setStatus('Could not validate configuration. Confirm the backend is running and reachable.', 'status-error');
        debugEl.textContent = err.message;
      }
    }

    async function sendMessage() {
      const payload = {
        session_id: sessionStorage.getItem('gatewaySession') || null,
        channel: document.getElementById('channel').value,
        message: document.getElementById('message').value,
        provider_selection: {
          llm_provider: document.getElementById('llm-provider').value,
          llm_model: document.getElementById('llm-model').value || 'assistant-lite',
          rag_provider: document.getElementById('rag-provider').value || null,
          rag_index: document.getElementById('rag-index').value || null,
          stt_provider: document.getElementById('stt-provider').value || null,
          stt_model: document.getElementById('stt-model').value || null,
          tts_provider: document.getElementById('tts-provider').value || null,
          tts_voice: document.getElementById('tts-voice').value || null,
          servicedesk_provider: document.getElementById('servicedesk-provider').value || null,
        },
        use_rag: document.getElementById('use-rag').checked,
        include_debug: document.getElementById('include-debug').checked,
      };

      try {
        const res = await fetch(`${apiBase}/v1/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload),
        });
        if (!res.ok) throw new Error(`Chat failed: ${res.status}`);
        const data = await res.json();
        if (data.session_id) {
          sessionStorage.setItem('gatewaySession', data.session_id);
        }
        responseEl.textContent = data.reply || JSON.stringify(data, null, 2);
        debugEl.textContent = JSON.stringify({
          providers: data.providers,
          used_rag: data.used_rag,
          servicedesk_action: data.servicedesk_action,
          debug: data.debug,
          simulated_costs: { tokens: data.debug?.llm_usage?.completion_tokens || 0, seconds: (data.debug?.latency_ms || 0)/1000 }
        }, null, 2);
      } catch (err) {
        responseEl.textContent = 'Request failed. Check the backend logs or adjust your API base URL.';
        debugEl.textContent = err.message;
      }
    }

    document.getElementById('send').addEventListener('click', sendMessage);
    document.getElementById('validate-btn').addEventListener('click', validateConfig);
    document.getElementById('save-api-base').addEventListener('click', () => {
      apiBase = apiBaseInput.value || 'http://localhost:8000';
      localStorage.setItem('apiBase', apiBase);
      setStatus('Saved endpoint. Refreshing registry...', 'status-warning');
      loadRegistry();
      validateConfig();
    });

    loadRegistry();
    validateConfig();
    applyPreset(presetEl.value);
  </script>
</body>
</html>
